<#
.SYNOPSIS 
    Reminds users to setup MFA in M365.
.DESCRIPTION 
    Pulls users that have SSPR enabled but not MFA in M365 and sends them a reminder email to setup MFA.
.NOTES 
    Requirements:
        Microsoft Graph PowerShell SDK
    File Name: 
        mfaRemind.ps1
    By: 
        David Wassman
    Date:
        October 3, 2025
.OUTPUTS 
    Log file containing results of script run (CMtrace format)
#>

# ===========================
# Configuration
# ===========================
$tenantId = "1234567890"              # Azure AD tenant ID
$applicationId = "0987654321"         # App registration (client ID)
#$clientSecretValue = "097654321234567890" # Client secret value
$certThumbprint = "123456789098765433221abc"    # Thumbrpint of authentication certificate
$logFile = "C:\IT\Logs\mfaRemind_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"

# Counters for summary
$sentCount = 0
$skippedCount = 0
$failedCount = 0

# Function to log messages in CMTrace format
function Write-Log {
    param(
        [string]$Message,
        [int]$Type=1 # 1=Info, 2=Warning, 3=Error
    )
    $time = (Get-Date -Format "HH:mm:ss.ffffff")
    $date = (Get-Date -Format "MM-dd-yyyy")
    $thread = [System.Threading.Thread]::CurrentThread.ManagedThreadId
    $logEntry = "<![LOG[$Message]LOG]!><time=""$time"" date=""$date"" component=""mfaRemind.ps1"" context="""" type=""$Type"" thread=""$thread"" file=""$logFile"">"
    $entry = "$((Get-Date).ToString("yyyy-MM-dd HH:mm:ss")) - $Message"
    Add-Content -Path $logFile -Value $logEntry
    Write-Output $entry
}

# ===========================
# Authentication
# ===========================
# Get certificate object
$cert = Get-ChildItem Cert:\LocalMachine\My\$certThumbprint
    
#$pass = ConvertTo-SecureString -String $clientSecretValue -AsPlainText -Force

# Build credential object (App ID + secret)
#$cred = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $applicationId, $pass

# Connect to Microsoft Graph with app-only authentication
try {
    #Connect-MgGraph -TenantId $tenantId -ClientSecretCredential $cred -NoWelcome
    Connect-MgGraph -TenantId $tenantId -ClientId $applicationId -Certificate $cert -NoWelcome
    Write-Log -Message "Connected to Microsoft Graph successfully." -Type 1
}
catch {
    Write-Log -Message "ERROR: Failed to connect to Microsoft Graph. $_" -Type 3
    exit 1
}

# ===========================
# Email Setup
# ===========================
$sender = "sender@example.com"   # From address
$subject = "Action Required: Please Enable MFA for Microsoft 365"

# Attachment: MFA setup guide
$filePath = "C:\IT\M365 Multifactor Authentication Enrollment Guide.pdf"
$fileName = [System.IO.Path]::GetFileName($filePath)

# Determine MIME type and convert file to base64 for Graph API attachment
Add-Type -AssemblyName System.Web
$contentType = [System.Web.MimeMapping]::GetMimeMapping($fileName)
$attachmentContent = [Convert]::ToBase64String([IO.File]::ReadAllBytes($filePath))

# ===========================
# User Loop
# ===========================
# Get users who have SSPR enabled but are NOT MFA capable
try{
    $users = Get-MgReportAuthenticationMethodUserRegistrationDetail -All | Where-Object {
        $_.IsSsprEnabled -and -not $_.IsMfaCapable
    }   
    Write-Log -Message "Retrieved $($users.Count) users eligible for MFA reminder processing." -Type 1
}
catch{
    Write-Log -Message "Failed to retrive user list from Graph. $_" -Type 3
    exit 1
}

$users | ForEach-Object{
    $user = $($_.userPrincipalName).ToString().Trim()

    # Skip users who are members of "M365 MFA NoWarn" group
    $isNoWarn = $false
    try {
        $adUser = Get-ADUser -Filter {userPrincipalName -eq $user} -Properties MemberOf
        $noWarnGroup = (Get-ADGroup -Identity "M365 MFA NoWarn").DistinguishedName
        if ($adUser.MemberOf -contains $noWarnGroup) {
            $isNoWarn = $true
        }
    }
    catch {
        Write-Log -Message "WARNING: Could not check NoWarn group membership for $user. $_" -Type 2
        $isNoWarn = $true # default to skipping if check fails
    }

    if (-not $isNoWarn) {
        $recipient = "$($_.userPrincipalName)"

        # Email body (HTML formatted)
        $body = @"
Hello $($_.userDisplayName),<br>
<br>
Our records show that you have not yet set up Multi-Factor Authentication (MFA) on your Microsoft 365 account.<br>
MFA will be required when accessing Microsoft 365 outside the office.<br>
<br>
Please complete the setup today. Instructions are attached.<br>
<br>
If you need assistance, please reply to this email or send an email to the IT Help Desk at helpdesk@ocpmgmt.com.<br>
<br>
Thank you for helping us keep our systems secure.<br>
"@

        # Graph API message payload
        $emailParams = @{
            message = @{
                subject = $subject
                body = @{
                    contentType = "HTML"
                    content = $body
                }
                toRecipients = @(
                    @{
                        emailAddress = @{
                            address = $recipient
                        }
                    }
                )
                attachments = @(
                    @{
                        "@odata.type" = "#microsoft.graph.fileAttachment"
                        name = $fileName
                        contentType = $contentType
                        contentBytes = $attachmentContent
                    }
                )
            }
            saveToSentItems = "false"
        }

        # Attempt to send the email
        try {
            Send-MgUserMail -UserId $sender -BodyParameter $emailParams
            Write-Log -Message "SUCCESS: MFA reminder sent to $recipient" -Type 1
            $sentCount++
        }
        catch {
            Write-Log -Message "ERROR: Failed to send MFA reminder to $recipient. $_" -Type 2
            $failedCount++
        }
    }
    else {
        Write-Log -Message "SKIPPED: $user is in M365 MFA NoWarn group or check failed." -Type 1
        $skippedCount++
    }
}

# ===========================
# Summary
# ===========================
Write-Log -Message "Script completed." -Type 1
Write-Log -Message "Summary: Sent = $sentCount | Skipped = $skippedCount | Failed = $failedCount" -Type 1
Disconnect-MgGraph | Out-Null
